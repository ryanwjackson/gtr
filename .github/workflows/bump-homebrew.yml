name: Bump Homebrew Formula

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to bump (e.g., v0.1.0). Leave empty to use the release tag."
        required: false
        type: string
      dry_run:
        description: "If true, open a PR with a -dryrun suffix for safe testing."
        required: false
        default: "false"
        type: choice
        options: ["false", "true"]

permissions:
  contents: read
  pull-requests: write

jobs:
  bump:
    runs-on: macos-latest
    env:
      # ---- Customize these if your tap or formula path differ ----
      TAP_OWNER: ${{ vars.TAP_OWNER || 'ryanwjackson' }}
      TAP_REPO:  ${{ vars.TAP_REPO  || 'homebrew-tap' }}
      FORMULA_PATH: ${{ vars.FORMULA_PATH || 'Formula/gtr.rb' }}
      # ------------------------------------------------------------
    steps:
      - name: Checkout (handy if you later read files)
        uses: actions/checkout@v4

      - name: Ensure GH CLI is authenticated
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_BUMP_TOKEN }}
        run: gh auth status

      - name: Compute tarball URL and SHA256
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          # Prefer manual input on workflow_dispatch; else use the tag from the release ref
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.tag }}" ]]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${GITHUB_REF_NAME}"
          fi
          REPO="${{ github.repository }}"  # should be ryanwjackson/gtr
          TARBALL="https://github.com/${REPO}/archive/refs/tags/${TAG}.tar.gz"
          echo "Tarball: $TARBALL"

          curl -L "$TARBALL" -o source.tar.gz
          SHA256="$(shasum -a 256 source.tar.gz | awk '{print $1}')"

          echo "tag=$TAG"         >> "$GITHUB_OUTPUT"
          echo "tarball=$TARBALL" >> "$GITHUB_OUTPUT"
          echo "sha256=$SHA256"   >> "$GITHUB_OUTPUT"

      - name: Rebuild tarball with injected version & upload asset
        id: pack
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_BUMP_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.meta.outputs.tag }}"

          # Unpack original source
          rm -rf src
          mkdir -p src
          tar -xzf source.tar.gz -C src --strip-components=1

          # Inject version into script
          if command -v gsed >/dev/null 2>&1; then
            gsed -i 's/@VERSION@/'"$TAG"'/g' src/bin/gtr
          else
            sed -i '' 's/@VERSION@/'"$TAG"'/g' src/bin/gtr
          fi

          # Repack
          TAR="gtr-${TAG}.tar.gz"
          tar -czf "$TAR" -C src .

          # Compute SHA256
          SHA256="$(shasum -a 256 "$TAR" | awk '{print $1}')"
          echo "sha256=$SHA256" >> "$GITHUB_OUTPUT"
          echo "asset=$TAR" >> "$GITHUB_OUTPUT"

          # Upload asset to the release
          gh release upload "$TAG" "$TAR" --clobber

          # Get asset URL (browser download URL)
          ASSET_URL="$(gh release view "$TAG" --json assets -q '.assets[] | select(.name=="'"$TAR"'") | .url')"
          echo "asset_url=$ASSET_URL" >> "$GITHUB_OUTPUT"

      - name: Clone tap and bump formula
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_BUMP_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          gh repo clone "$TAP_OWNER/$TAP_REPO" tap
          cd tap

          # Determine dry-run suffix and branch name
          DRY="${{ github.event.inputs.dry_run || 'false' }}"
          SUFFIX=""
          if [[ "$DRY" == "true" ]]; then SUFFIX="-dryrun"; fi
          BRANCH="bump-gtr-${{ steps.meta.outputs.tag }}$SUFFIX"
          git checkout -b "$BRANCH"

          # Configure git identity (can also set via repo variables)
          git config user.name  "${{ vars.GIT_USER_NAME  || 'github-actions[bot]' }}"
          git config user.email "${{ vars.GIT_USER_EMAIL || '41898282+github-actions[bot]@users.noreply.github.com' }}"

          # Configure git to use GH CLI credentials for HTTPS pushes
          gh auth setup-git

          # In-place edit with Perl (portable across BSD/GNU)
          NEW_URL="${{ steps.pack.outputs.asset_url }}"
          NEW_SHA="${{ steps.pack.outputs.sha256 }}"
          URL="$NEW_URL" SHA="$NEW_SHA" perl -0777 -i -pe 's|^  url ".*"|  url "$ENV{URL}"|m; s|^  sha256 ".*"|  sha256 "$ENV{SHA}"|m' "$FORMULA_PATH"

          echo "Diff:"
          git --no-pager diff -- "$FORMULA_PATH" || true

          # If no changes were made, exit successfully (nothing to bump)
          if git diff --quiet -- "$FORMULA_PATH"; then
            echo "No changes detected in $FORMULA_PATH; skipping commit and PR."
            exit 0
          fi

          git add "$FORMULA_PATH"
          git commit -m "gtr: bump to ${{ steps.meta.outputs.tag }}$SUFFIX"
          git push -u origin "$BRANCH"

          # Open a PR targeting the tap's default branch
          gh pr create \
            --title "Bump gtr to ${{ steps.meta.outputs.tag }}$SUFFIX" \
            --body  "Automated bump (dry_run=${DRY}): update URL and SHA256 for ${{ steps.meta.outputs.tag }}." \
            --fill

      # Optional: uncomment to lint the formula in CI for extra safety
      # - name: Brew audit (optional)
      #   shell: bash
      #   run: |
      #     set -euo pipefail
      #     brew update
      #     brew audit --strict --new-formula "tap/$FORMULA_PATH"