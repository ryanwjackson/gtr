#!/bin/bash

# gtr post-create hook
# This hook runs AFTER successfully creating a new worktree
#
# Arguments:
#   $1 - worktree name
#   $2 - worktree path
#   $3 - branch name
#   $4 - base branch
#
# Exit codes:
#   0 - success
#   non-zero - failure (worktree will still exist, but hook failed)

WORKTREE_NAME="$1"
WORKTREE_PATH="$2"
BRANCH_NAME="$3"
BASE_BRANCH="$4"

echo "üéâ Post-create hook: $WORKTREE_NAME"

# Get the main worktree directory
MAIN_WORKTREE=$(git rev-parse --show-toplevel)
if [[ "$(git rev-parse --git-dir)" == *"/.git/worktrees/"* ]]; then
    # We're in a worktree, get the main repository
    MAIN_GIT_DIR=$(dirname "$(dirname "$(git rev-parse --git-dir)")")
    MAIN_WORKTREE=$(dirname "$MAIN_GIT_DIR")
fi

# Source the config functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -f "$MAIN_WORKTREE/lib/gtr-config.sh" ]]; then
    source "$MAIN_WORKTREE/lib/gtr-config.sh"
else
    echo "‚ö†Ô∏è  Warning: Could not find gtr-config.sh, using defaults"
fi

# Read configuration values
DOTENV_SYNC_METHOD=$(_gtr_read_config_setting "$MAIN_WORKTREE" "hooks.post-create" "DOTENV_SYNC_METHOD" "symlink")
RUN_PNPM=$(_gtr_read_config_setting "$MAIN_WORKTREE" "settings" "run_pnpm" "true")

# Sync .env files using the configured method
echo "üìã Syncing local files to worktree..."

if [[ "$DOTENV_SYNC_METHOD" == "copy" ]]; then
    echo "  Using copy method for .env files..."
    if [[ -f "$SCRIPT_DIR/helpers/copy-dotenv" ]]; then
        copied_files=()
        while IFS= read -r file; do
            [[ -n "$file" ]] && copied_files+=("$file")
        done < <("$SCRIPT_DIR/helpers/copy-dotenv" "$MAIN_WORKTREE" "$WORKTREE_PATH")
        
        if [[ ${#copied_files[@]} -gt 0 ]]; then
            echo "üìã Copied local files: ${copied_files[*]}"
        else
            echo "‚ÑπÔ∏è  No local files found to copy"
        fi
    else
        echo "‚ö†Ô∏è  copy-dotenv helper not found, skipping file sync"
    fi
elif [[ "$DOTENV_SYNC_METHOD" == "symlink" ]]; then
    echo "  Using symlink method for .env files..."
    if [[ -f "$SCRIPT_DIR/helpers/symlink-dotenv" ]]; then
        symlinked_files=()
        while IFS= read -r file; do
            [[ -n "$file" ]] && symlinked_files+=("$file")
        done < <("$SCRIPT_DIR/helpers/symlink-dotenv" "$MAIN_WORKTREE" "$WORKTREE_PATH")
        
        if [[ ${#symlinked_files[@]} -gt 0 ]]; then
            echo "üîó Symlinked local files: ${symlinked_files[*]}"
        else
            echo "‚ÑπÔ∏è  No local files found to symlink"
        fi
    else
        echo "‚ö†Ô∏è  symlink-dotenv helper not found, skipping file sync"
    fi
else
    echo "‚ö†Ô∏è  Unknown DOTENV_SYNC_METHOD: $DOTENV_SYNC_METHOD (expected 'copy' or 'symlink')"
fi

# Run pnpm commands if enabled
if [[ -f "$SCRIPT_DIR/helpers/run-pnpm" ]]; then
    "$SCRIPT_DIR/helpers/run-pnpm" "$WORKTREE_PATH" "$RUN_PNPM"
else
    echo "‚ö†Ô∏è  run-pnpm helper not found, skipping pnpm commands"
fi

echo "‚úÖ Post-create setup completed"
exit 0